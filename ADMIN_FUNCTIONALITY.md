# Функциональность администратора в Fiesta

## Обзор

В приложение Fiesta добавлена система администрирования, которая позволяет назначать пользователей администраторами и предоставлять им дополнительные возможности управления системой.

## Возможности администратора

### 1. Визуальная индикация
- **Бейдж "Админ"** на аватаре пользователя (красная звезда)
- **Красная рамка** вокруг аватара
- **Лейбл "Админ"** рядом с именем пользователя
- **Индикация в меню** пользователя

### 2. Админ-панель
Администраторы имеют доступ к специальной панели с:
- **Общей статистикой системы:**
  - Всего пользователей
  - Всего мероприятий
  - Активные мероприятия
  - Частные мероприятия
  - Всего откликов
  - Количество администраторов

- **Информацией о системе:**
  - Последние обновления
  - Версия приложения
  - Используемые технологии

### 3. Доступ к админ-панели
- Появляется новый пункт меню "Админ-панель" в бургер-меню
- Доступен только для пользователей с флагом `is_admin = true`

## Техническая реализация

### База данных

#### Миграция
Файл: `supabase/migrations/20241220_add_admin_field.sql`
- Добавляет поле `is_admin BOOLEAN NOT NULL DEFAULT FALSE` в таблицу `users`
- Создает индекс для оптимизации запросов
- Добавляет функции для проверки и установки админского статуса
- Настраивает RLS политики

#### Функции базы данных
```sql
-- Проверка статуса администратора
is_user_admin(user_telegram_id BIGINT) RETURNS BOOLEAN

-- Установка статуса администратора
set_user_admin(user_telegram_id BIGINT, admin_status BOOLEAN DEFAULT TRUE) RETURNS BOOLEAN
```

### Код приложения

#### Новые компоненты
1. **AdminService** (`src/services/adminService.ts`)
   - Проверка админского статуса
   - Установка админского статуса
   - Получение списка админов
   - Получение админской статистики

2. **useAdminStatus** (`src/hooks/useAdminStatus.ts`)
   - React хук для управления админским статусом
   - Автоматическая проверка при загрузке
   - Функция обновления статуса

3. **AdminPanel** (`src/components/AdminPanel.tsx`)
   - Полноэкранная панель администратора
   - Отображение статистики
   - Проверка прав доступа

#### Обновленные компоненты
1. **TelegramUserInfo** - добавлен бейдж администратора
2. **UserMenu** - добавлен пункт админ-панели
3. **App.tsx** - интеграция админ-панели
4. **database.ts** - обновлены типы с полем `is_admin`

## Назначение администратора

### Вариант 1: Ручное SQL-обновление
```sql
-- Сделать пользователя администратором
UPDATE users 
SET is_admin = true, updated_at = NOW()
WHERE telegram_id = YOUR_TELEGRAM_ID;

-- Проверить статус
SELECT telegram_id, first_name, is_admin 
FROM users 
WHERE telegram_id = YOUR_TELEGRAM_ID;
```

### Вариант 2: Использование функции
```sql
-- Назначить администратором
SELECT set_user_admin(YOUR_TELEGRAM_ID, true);

-- Убрать админские права
SELECT set_user_admin(YOUR_TELEGRAM_ID, false);
```

### Вариант 3: Готовый скрипт
Используйте файл `database/make_admin.sql`, заменив в нем нужный Telegram ID.

## Безопасность

### RLS политики
- Администраторы могут видеть всех пользователей включая админский статус
- Обычные пользователи видят только базовую информацию
- Админский статус защищен от несанкционированного изменения

### Проверки доступа
- Все админские функции проверяют права доступа
- Админ-панель недоступна без соответствующих прав
- Статус администратора проверяется на стороне сервера

## Использование

### Для пользователей
1. Если вы администратор, в правом верхнем углу появится красный бейдж "Админ"
2. В бургер-меню появится новый пункт "Админ-панель"
3. При клике откроется панель с системной статистикой

### Для разработчиков
1. Примените миграцию: `supabase/migrations/20241220_add_admin_field.sql`
2. Назначьте администратора используя SQL-скрипт
3. Перезапустите приложение для обновления интерфейса

## Расширения

Система администрирования спроектирована для легкого расширения:
- Добавление новых админских функций в `AdminService`
- Расширение админ-панели новыми разделами
- Добавление ролевой модели (super admin, moderator, etc.)
- Интеграция с системой логирования действий

## Мониторинг

### Аналитика
Все действия администраторов отслеживаются через Яндекс.Метрику:
- `admin_panel_opened` - открытие админ-панели
- `header_admin_panel_clicked` - клик по админ-панели в меню

### Логирование
Все админские операции логируются в консоль браузера с детальной информацией.

---

**Примечание:** Первого администратора необходимо назначить вручную через базу данных. После этого будущих администраторов можно будет назначать через интерфейс (когда эта функция будет добавлена). 