<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiesta Debug</title>
    <style>
        body { font-family: system-ui; max-width: 600px; margin: 50px auto; padding: 20px; line-height: 1.5; }
        .test { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { border-color: #4CAF50; background: #f0fff0; }
        .error { border-color: #f44336; background: #fff0f0; }
        .info { border-color: #2196F3; background: #f0f8ff; }
        button { background: #2196F3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976D2; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; font-size: 11px; }
        .loading { color: #666; }
        .env-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîß Fiesta Debug Page</h1>
    <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å Supabase –∏ Telegram WebApp</p>
    
    <div class="env-info">
        <h3>üìç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏:</h3>
        <div id="env-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <button onclick="runTests()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã Supabase</button>
    <button onclick="testTelegram()">üì± –¢–µ—Å—Ç Telegram WebApp</button>
    <button onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    
    <div id="results"></div>

    <script>
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏
        document.getElementById('env-info').innerHTML = `
            <strong>URL:</strong> ${window.location.href}<br>
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>Platform:</strong> ${navigator.platform}<br>
            <strong>Language:</strong> ${navigator.language}<br>
            <strong>Telegram WebApp:</strong> ${typeof window.Telegram !== 'undefined' ? '‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' : '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}<br>
            <strong>–í—Ä–µ–º—è:</strong> ${new Date().toLocaleString()}
        `;

        let testResults = [];
        
        function log(message) {
            console.log(message);
            const results = document.getElementById('results');
            results.innerHTML += `<div style="margin: 5px 0; font-family: monospace; font-size: 14px;">${message}</div>`;
        }

        function addTest(name, status, message, details = null) {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${status === 'success' ? '‚úÖ' : status === 'info' ? '‚ÑπÔ∏è' : '‚ùå'} ${name}</h3>
                <p>${message}</p>
                ${details ? `<details><summary>–î–µ—Ç–∞–ª–∏</summary><pre>${JSON.stringify(details, null, 2)}</pre></details>` : ''}
            `;
            document.getElementById('results').appendChild(div);
        }

        async function testTelegram() {
            document.getElementById('results').innerHTML = '';
            log('üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram WebApp...');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram –æ–∫—Ä—É–∂–µ–Ω–∏—è
            const telegramTest = {
                hasTelegram: typeof window.Telegram !== 'undefined',
                hasWebApp: typeof window.Telegram?.WebApp !== 'undefined',
                webAppData: window.Telegram?.WebApp?.initDataUnsafe || null,
                webAppUser: window.Telegram?.WebApp?.initDataUnsafe?.user || null,
                isExpanded: window.Telegram?.WebApp?.isExpanded || false,
                viewportHeight: window.Telegram?.WebApp?.viewportHeight || 0,
                colorScheme: window.Telegram?.WebApp?.colorScheme || 'unknown'
            };

            if (telegramTest.hasTelegram) {
                addTest('Telegram WebApp', 'success', 'Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω', telegramTest);
                
                if (telegramTest.webAppUser) {
                    addTest('Telegram User', 'success', `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${telegramTest.webAppUser.first_name}`, telegramTest.webAppUser);
                } else {
                    addTest('Telegram User', 'error', '–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã', null);
                }
            } else {
                addTest('Telegram WebApp', 'error', 'Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.', telegramTest);
            }

            log('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        }

        async function runTests() {
            document.getElementById('results').innerHTML = '';
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Supabase...');

            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            let SUPABASE_URL, SUPABASE_KEY;
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                const response = await fetch('/');
                const html = await response.text();
                
                // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ö–∞—Ä–¥–∫–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ .env.local
                SUPABASE_URL = 'https://xajclkhhskkrgqwzhlnz.supabase.co';
                SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhamNsa2hoc2trcmdxd3pobG56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgwNzIwNDYsImV4cCI6MjA2MzY0ODA0Nn0.K76opG9RFtM8iQQaQxDBIYgbiTmM61Hp8fGgA-Q2i9o';
                
                addTest('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è', 'info', `URL: ${SUPABASE_URL}`, {
                    url: SUPABASE_URL,
                    keyLength: SUPABASE_KEY.length
                });
            } catch (err) {
                addTest('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è', 'error', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é', err.toString());
                return;
            }

            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            log('üîÑ –¢–µ—Å—Ç 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase');
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?select=id&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addTest('Supabase API', 'success', `–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (—Å—Ç–∞—Ç—É—Å: ${response.status})`, {
                        status: response.status,
                        data: data,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                } else {
                    const errorText = await response.text();
                    addTest('Supabase API', 'error', `–û—à–∏–±–∫–∞ API (—Å—Ç–∞—Ç—É—Å: ${response.status})`, {
                        status: response.status,
                        error: errorText,
                        headers: Object.fromEntries(response.headers.entries())
                    });
                }
            } catch (err) {
                addTest('Supabase API', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ Supabase', {
                    error: err.toString(),
                    stack: err.stack
                });
            }

            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            log('üîÑ –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            try {
                const testUser = {
                    telegram_id: Math.floor(Math.random() * 1000000000), // –°–ª—É—á–∞–π–Ω—ã–π ID
                    first_name: 'Debug User',
                    last_name: 'Test',
                    username: `debug_${Date.now()}`,
                    language_code: 'ru',
                    is_premium: false
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testUser)
                });

                if (response.ok) {
                    const data = await response.json();
                    addTest('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'success', '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω', {
                        testUser,
                        result: data
                    });
                    
                    // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (data && data[0] && data[0].id) {
                        const deleteResponse = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${data[0].id}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        });
                        if (deleteResponse.ok) {
                            log('üóëÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                        }
                    }
                } else {
                    const errorText = await response.text();
                    addTest('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', `–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (${response.status})`, {
                        status: response.status,
                        error: errorText,
                        testUser: testUser
                    });
                }
            } catch (err) {
                addTest('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', {
                    error: err.toString(),
                    stack: err.stack
                });
            }

            log('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Supabase –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç Telegram –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            testTelegram();
        });
    </script>
</body>
</html> 